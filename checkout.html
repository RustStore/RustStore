<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Rust Store</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://js.stripe.com/v3/"></script>
    <script src="payment-config.js"></script>
    <script id="paypal-sdk"></script>
    <style>
        * { font-family: 'Rajdhani', sans-serif; }
        .orbitron { font-family: 'Orbitron', monospace; }
        
        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            background: #000;
            overflow-x: hidden;
        }
        
        .checkout-container {
            position: relative;
            z-index: 10;
            padding: 120px 20px 120px 20px;
            min-height: calc(100vh - 240px);
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(5px);
        }
        
        .checkout-card {
            background: linear-gradient(145deg, rgba(0, 0, 0, 0.95), rgba(20, 20, 20, 0.98));
            border: 2px solid #ffd700;
            border-radius: 20px;
            padding: 0;
            max-width: 1000px;
            margin: 0 auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8), 0 0 40px rgba(255, 215, 0, 0.2);
            overflow: hidden;
        }
        
        .checkout-header {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 215, 0, 0.05));
            padding: 2rem 2rem 1.5rem 2rem;
            border-bottom: 1px solid rgba(255, 215, 0, 0.3);
        }
        
        .checkout-content {
            padding: 2rem;
        }
        
        .order-summary {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }
        
        .payment-methods {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .payment-method {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 15px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .payment-method:hover {
            border-color: #ffd700;
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.2);
        }
        
        .payment-method.selected {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.1);
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.3);
        }
        
        .payment-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .paypal-icon {
            color: #0070ba;
        }
        
        .stripe-icon {
            color: #6772e5;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-label {
            display: block;
            color: #fff;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        .form-input {
            width: 100%;
            padding: 1rem;
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.5);
            color: #fff;
            font-size: 1rem;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #ffd700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }
        
        .card-element {
            padding: 1rem;
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.5);
            color: #fff;
        }
        
        .pay-button {
            width: 100%;
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            border: none;
            color: #000;
            padding: 1.2rem;
            border-radius: 15px;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 20px rgba(255, 215, 0, 0.3);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .pay-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.5);
        }
        
        .pay-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .error-message {
            color: #ff4757;
            background: rgba(255, 71, 87, 0.1);
            border: 1px solid rgba(255, 71, 87, 0.3);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: none;
        }
        
        .success-message {
            color: #00ff88;
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: none;
        }
        
        .item-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .item-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .item-icon {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-size: 1.2rem;
        }
        
        .total-section {
            border-top: 2px solid rgba(255, 215, 0, 0.3);
            padding-top: 1.5rem;
            margin-top: 1.5rem;
        }
        
        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        
        .total-final {
            font-size: 1.5rem;
            font-weight: 700;
            color: #ffd700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }
        
        @media (max-width: 768px) {
            .payment-methods {
                grid-template-columns: 1fr;
            }
            
            .checkout-content {
                padding: 1rem;
            }
        }
    </style>
</head>
<body class="text-white">
    <!-- Full Screen Background YouTube Video -->
    <div id="youtube-background" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: -1; opacity: 0.8; pointer-events: none;">
        <iframe 
            id="youtube-video"
            width="100%" 
            height="100%" 
            src="https://www.youtube.com/embed/2IZshrjPzB4?autoplay=1&mute=1&loop=1&playlist=2IZshrjPzB4&controls=0&showinfo=0&rel=0&iv_load_policy=3&modestbranding=1&playsinline=1&enablejsapi=1&origin=http://localhost:3000" 
            frameborder="0" 
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
            allowfullscreen
            style="pointer-events: none;">
        </iframe>
    </div>

    <div class="checkout-container">
        <div class="checkout-card">
            <!-- Checkout Header -->
            <div class="checkout-header">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center;">
                        <div style="background: linear-gradient(135deg, #ffd700, #ffed4e); width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 1rem; box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);">
                            <i class="fas fa-credit-card" style="color: #000; font-size: 1.5rem;"></i>
                        </div>
                        <div>
                            <h2 style="color: #ffd700; font-size: 1.8rem; margin: 0; font-weight: 700; text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);">
                                Secure Checkout
                            </h2>
                            <p style="color: #ccc; margin: 0; font-size: 0.9rem;">Complete your Rust store purchase</p>
                        </div>
                    </div>
                    <button onclick="window.history.back()" style="background: rgba(255, 255, 255, 0.1); border: none; color: #ffd700; font-size: 1.5rem; cursor: pointer; width: 40px; height: 40px; border-radius: 50%; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <!-- Checkout Content -->
            <div class="checkout-content">
                <!-- Error/Success Messages -->
                <div id="errorMessage" class="error-message"></div>
                <div id="successMessage" class="success-message"></div>

                <!-- Order Summary -->
                <div class="order-summary">
                    <h3 style="color: #ffd700; font-size: 1.3rem; margin-bottom: 1.5rem; font-weight: 600;">
                        <i class="fas fa-shopping-cart" style="margin-right: 0.5rem;"></i>Order Summary
                    </h3>
                    <div id="orderItems">
                        <!-- Order items will be populated by JavaScript -->
                    </div>
                    <div class="total-section">
                        <div class="total-row">
                            <span>Subtotal:</span>
                            <span id="subtotal">$0.00</span>
                        </div>
                        <div class="total-row">
                            <span>Tax:</span>
                            <span id="tax">$0.00</span>
                        </div>
                        <div class="total-row total-final">
                            <span>Total:</span>
                            <span id="total">$0.00</span>
                        </div>
                    </div>
                </div>

                <!-- Payment Methods -->
                <div class="payment-methods">
                    <div class="payment-method" onclick="selectPaymentMethod('paypal')" id="paypalMethod">
                        <div class="payment-icon paypal-icon">
                            <i class="fab fa-paypal"></i>
                        </div>
                        <h4 style="color: #fff; margin-bottom: 0.5rem;">PayPal</h4>
                        <p style="color: #ccc; font-size: 0.9rem; margin: 0;">Pay with PayPal account or card</p>
                    </div>
                    
                    <div class="payment-method" onclick="selectPaymentMethod('stripe')" id="stripeMethod">
                        <div class="payment-icon stripe-icon">
                            <i class="fas fa-credit-card"></i>
                        </div>
                        <h4 style="color: #fff; margin-bottom: 0.5rem;">Stripe</h4>
                        <p style="color: #ccc; font-size: 0.9rem; margin: 0;">Pay with any major credit card</p>
                    </div>
                </div>

                <!-- Payment Forms -->
                <div id="paypalForm" style="display: none;">
                    <div id="paypal-button-container"></div>
                </div>

                <div id="stripeForm" style="display: none;">
                    <form id="payment-form">
                        <div class="form-group">
                            <label class="form-label">Email Address</label>
                            <input type="email" id="email" class="form-input" required placeholder="your@email.com">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Game ID / Username</label>
                            <input type="text" id="gameId" class="form-input" required placeholder="Your Rust game ID">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Card Information</label>
                            <div id="card-element" class="card-element">
                                <!-- Stripe Card Element will be inserted here -->
                            </div>
                            <div id="card-errors" style="color: #ff4757; margin-top: 0.5rem; font-size: 0.9rem;"></div>
                        </div>
                        
                        <button type="submit" id="stripeSubmit" class="pay-button">
                            <i class="fas fa-lock" style="margin-right: 0.5rem;"></i>Pay Securely
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration from payment-config.js
        const STRIPE_PUBLISHABLE_KEY = window.PAYMENT_CONFIG?.stripe?.publishableKey || 'pk_test_your_stripe_publishable_key';
        const PAYPAL_CLIENT_ID = window.PAYMENT_CONFIG?.paypal?.clientId || 'your_paypal_client_id';
        
        // Initialize Stripe
        const stripe = Stripe(STRIPE_PUBLISHABLE_KEY);
        const elements = stripe.elements();
        
        // Create card element
        const cardElement = elements.create('card', {
            style: {
                base: {
                    fontSize: '16px',
                    color: '#ffffff',
                    '::placeholder': {
                        color: '#aab7c4'
                    }
                },
                invalid: {
                    color: '#ff4757',
                    iconColor: '#ff4757'
                }
            }
        });
        
        // Mount card element
        cardElement.mount('#card-element');
        
        // Handle card errors
        cardElement.addEventListener('change', function(event) {
            const displayError = document.getElementById('card-errors');
            if (event.error) {
                displayError.textContent = event.error.message;
            } else {
                displayError.textContent = '';
            }
        });
        
        // Global variables
        let selectedPaymentMethod = null;
        let orderItems = [];
        let orderTotal = 0;
        
        // Initialize checkout
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Load PayPal SDK dynamically
                await loadPayPalSDK();
                console.log('PayPal SDK loaded and ready');
            } catch (error) {
                console.error('Error loading PayPal SDK:', error);
            }
            
            loadOrderFromCart();
            setupEventListeners();
        });
        
        async function loadPayPalSDK() {
            return new Promise(async (resolve, reject) => {
                if (window.paypal) {
                    resolve();
                    return;
                }
                
                try {
                    // Fetch PayPal Client ID from server
                    const response = await fetch('/.netlify/functions/get-paypal-config');
                    const config = await response.json();
                    
                    if (!config.clientId) {
                        throw new Error('PayPal Client ID not available');
                    }
                    
                    const paypalScript = document.getElementById('paypal-sdk');
                    paypalScript.src = `https://www.paypal.com/sdk/js?client-id=${config.clientId}&currency=USD`;
                    
                    paypalScript.onload = () => {
                        console.log('PayPal SDK loaded successfully');
                        resolve();
                    };
                    
                    paypalScript.onerror = () => {
                        console.error('Failed to load PayPal SDK');
                        reject(new Error('PayPal SDK failed to load'));
                    };
                } catch (error) {
                    console.error('Error loading PayPal config:', error);
                    reject(error);
                }
            });
        }
        
        function loadOrderFromCart() {
            // Load cart items from localStorage
            const cartItems = JSON.parse(localStorage.getItem('cartItems') || '[]');
            orderItems = cartItems;
            
            // Calculate totals
            const subtotal = cartItems.reduce((sum, item) => sum + item.subtotal, 0);
            const tax = subtotal * 0.08; // 8% tax
            orderTotal = subtotal + tax;
            
            // Update UI
            updateOrderSummary();
            updateTotals(subtotal, tax, orderTotal);
        }
        
        function updateOrderSummary() {
            const orderItemsContainer = document.getElementById('orderItems');
            
            if (orderItems.length === 0) {
                orderItemsContainer.innerHTML = '<p style="color: #ccc; text-align: center;">No items in cart</p>';
                return;
            }
            
            orderItemsContainer.innerHTML = orderItems.map(item => `
                <div class="item-card">
                    <div class="item-info">
                        <div class="item-icon">
                            <i class="fas ${getItemIcon(item.item.type || item.item.resourceType)}"></i>
                        </div>
                        <div>
                            <h4 style="color: #fff; margin: 0 0 0.2rem 0;">${item.item.name}</h4>
                            <p style="color: #ccc; margin: 0; font-size: 0.9rem;">Qty: ${item.quantity}</p>
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="color: #ffd700; font-weight: 700; font-size: 1.1rem;">$${(item.subtotal / 100).toFixed(2)}</div>
                    </div>
                </div>
            `).join('');
        }
        
        function updateTotals(subtotal, tax, total) {
            document.getElementById('subtotal').textContent = `$${(subtotal / 100).toFixed(2)}`;
            document.getElementById('tax').textContent = `$${(tax / 100).toFixed(2)}`;
            document.getElementById('total').textContent = `$${(total / 100).toFixed(2)}`;
        }
        
        function getItemIcon(type) {
            const icons = {
                'resource-bundle': 'fas fa-boxes',
                'raid-kit': 'fas fa-bomb',
                'vip': 'fas fa-crown',
                'vip_plus': 'fas fa-star',
                'wood': 'fas fa-tree',
                'stone': 'fas fa-mountain',
                'metal': 'fas fa-cog',
                'cloth': 'fas fa-tshirt',
                'scrap': 'fas fa-recycle',
                'hqm': 'fas fa-gem',
                'fuel': 'fas fa-fire'
            };
            return icons[type] || 'fas fa-box';
        }
        
        function selectPaymentMethod(method) {
            selectedPaymentMethod = method;
            
            // Update UI
            document.querySelectorAll('.payment-method').forEach(el => el.classList.remove('selected'));
            document.getElementById(method + 'Method').classList.add('selected');
            
            // Show/hide forms
            document.getElementById('paypalForm').style.display = method === 'paypal' ? 'block' : 'none';
            document.getElementById('stripeForm').style.display = method === 'stripe' ? 'block' : 'none';
            
            // Initialize PayPal if selected
            if (method === 'paypal') {
                initializePayPal();
            }
        }
        
        function initializePayPal() {
            // Clear existing buttons
            const container = document.getElementById('paypal-button-container');
            container.innerHTML = '';
            
            if (window.paypal) {
                paypal.Buttons({
                    createOrder: function(data, actions) {
                        return actions.order.create({
                            purchase_units: [{
                                amount: {
                                    value: (orderTotal / 100).toFixed(2)
                                },
                                description: 'Rust Store Purchase',
                                custom_id: generateOrderId()
                            }]
                        });
                    },
                    onApprove: function(data, actions) {
                        return actions.order.capture().then(function(details) {
                            handlePaymentSuccess(details, 'paypal');
                        });
                    },
                    onError: function(err) {
                        console.error('PayPal error:', err);
                        handlePaymentError(err, 'PayPal');
                    }
                }).render('#paypal-button-container');
                
                console.log('PayPal button rendered successfully');
            } else {
                console.error('PayPal SDK not available');
                container.innerHTML = '<p style="color: #ff4757;">PayPal is currently unavailable. Please try Stripe instead.</p>';
            }
        }
        
        function setupEventListeners() {
            // Stripe form submission
            const form = document.getElementById('payment-form');
            form.addEventListener('submit', function(event) {
                event.preventDefault();
                processStripePayment();
            });
        }
        
        async function processStripePayment() {
            const submitButton = document.getElementById('stripeSubmit');
            const email = document.getElementById('email').value;
            const gameId = document.getElementById('gameId').value;
            
            if (!email || !gameId) {
                showError('Please fill in all required fields');
                return;
            }
            
            // Disable button and show loading
            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="loading"></span> Processing...';
            
            try {
                // Create payment intent on your server
                const response = await fetch('/.netlify/functions/create-payment-intent', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        amount: orderTotal,
                        email: email,
                        gameId: gameId,
                        items: orderItems
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Payment failed');
                }
                
                // Confirm payment with Stripe
                const { error, paymentIntent } = await stripe.confirmCardPayment(data.clientSecret, {
                    payment_method: {
                        card: cardElement,
                        billing_details: {
                            email: email
                        }
                    }
                });
                
                if (error) {
                    throw new Error(error.message);
                }
                
                // Payment successful
                handlePaymentSuccess(paymentIntent, 'stripe');
                
            } catch (error) {
                handlePaymentError(error, 'Stripe');
            } finally {
                // Re-enable button
                submitButton.disabled = false;
                submitButton.innerHTML = '<i class="fas fa-lock" style="margin-right: 0.5rem;"></i>Pay Securely';
            }
        }
        
        function handlePaymentSuccess(paymentDetails, method) {
            // Clear cart
            localStorage.removeItem('cartItems');
            
            // Show success message
            showSuccess(`Payment successful! Your items will be delivered in-game. Transaction ID: ${paymentDetails.id || paymentDetails.payment_intent}`);
            
            // Redirect to success page or back to store
            setTimeout(() => {
                window.location.href = '/index.html';
            }, 3000);
        }
        
        function handlePaymentError(error, method) {
            showError(`${method} payment failed: ${error.message}`);
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            // Hide success message if showing
            document.getElementById('successMessage').style.display = 'none';
        }
        
        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            
            // Hide error message if showing
            document.getElementById('errorMessage').style.display = 'none';
        }
        
        function generateOrderId() {
            return 'order_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
    </script>
</body>
</html> 